# ğŸ“Š æ•°æ®è·å–å®ç°è®¡åˆ’

## ğŸ¯ åŸºäºTushareå…è´¹ç‰ˆçš„å®ç°æ–¹æ¡ˆ

æ ¹æ®Tushareå…è´¹ç‰ˆçš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

---

## âœ… ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ•°æ®ï¼ˆå·²å®Œæˆï¼‰

### 1. æ•°æ®æºé…ç½® âœ…
- [x] Tushare Tokené…ç½®
- [x] è¿æ¥æµ‹è¯•
- [x] æ•°æ®æºæ¿€æ´»

**å·²å®ç°çš„API**:
- `GET /api/datasources` - è·å–æ•°æ®æºåˆ—è¡¨
- `POST /api/datasources/{id}/test` - æµ‹è¯•è¿æ¥
- `PUT /api/datasources/{id}` - æ›´æ–°é…ç½®

---

## ğŸ”„ ç¬¬äºŒé˜¶æ®µï¼šè‚¡ç¥¨åˆ—è¡¨ä¸è¡Œæƒ…ï¼ˆå¾…å®ç°ï¼‰

### 2.1 è‚¡ç¥¨åˆ—è¡¨æ•°æ®

**Tushareæ¥å£**: `pro.stock_basic()`

**åŠŸèƒ½**:
- è·å–æ‰€æœ‰Aè‚¡ä¸Šå¸‚å…¬å¸
- æ”¯æŒæŒ‰è¡Œä¸šç­›é€‰
- æ”¯æŒæŒ‰åœ°åŸŸç­›é€‰
- æ”¯æŒå¸‚åœºç±»å‹ç­›é€‰

**åç«¯éœ€è¦å®ç°**:
```python
# app/services/tushare_service.py
def get_stock_list(self, exchange='', list_status='L', market=''):
    """
    è·å–è‚¡ç¥¨åˆ—è¡¨
    
    å‚æ•°:
        exchange: äº¤æ˜“æ‰€ (SSE/SZSE)
        list_status: ä¸Šå¸‚çŠ¶æ€ (Lä¸Šå¸‚/Dé€€å¸‚/Pæš‚åœ)
        market: å¸‚åœºç±»å‹ (ä¸»æ¿/åˆ›ä¸šæ¿/ç§‘åˆ›æ¿/åŒ—äº¤æ‰€)
    """
    df = self.pro.stock_basic(
        exchange=exchange,
        list_status=list_status,
        market=market,
        fields='ts_code,symbol,name,area,industry,market,list_date'
    )
    return df.to_dict('records')
```

**å‰ç«¯æ¥å£**: å·²å­˜åœ¨
- `GET /api/stocks?industry=é“¶è¡Œ&area=æ·±åœ³`

**å‰ç«¯å±•ç¤º**:
- è‚¡ç¥¨åˆ—è¡¨å¡ç‰‡
- è¡Œä¸šç­›é€‰
- åœ°åŸŸç­›é€‰
- æœç´¢åŠŸèƒ½

---

### 2.2 æ—¥çº¿è¡Œæƒ…æ•°æ®

**Tushareæ¥å£**: `pro.daily()`

**åŠŸèƒ½**:
- è·å–Kçº¿æ•°æ®
- ç”¨äºå›¾è¡¨å±•ç¤º
- å†å²å›æµ‹

**åç«¯éœ€è¦å®ç°**:
```python
# app/services/tushare_service.py
def get_daily_data(self, ts_code, start_date=None, end_date=None, limit=60):
    """
    è·å–æ—¥çº¿è¡Œæƒ…
    
    å‚æ•°:
        ts_code: è‚¡ç¥¨ä»£ç 
        start_date: å¼€å§‹æ—¥æœŸ (YYYYMMDD)
        end_date: ç»“æŸæ—¥æœŸ (YYYYMMDD)
        limit: è¿”å›æœ€è¿‘Nå¤©
    """
    if not start_date and not end_date:
        # å¦‚æœæ²¡æœ‰æŒ‡å®šæ—¥æœŸï¼Œè¿”å›æœ€è¿‘limitå¤©
        end_date = datetime.now().strftime('%Y%m%d')
        start_date = (datetime.now() - timedelta(days=limit*2)).strftime('%Y%m%d')
    
    df = self.pro.daily(
        ts_code=ts_code,
        start_date=start_date,
        end_date=end_date
    )
    return df.to_dict('records')
```

**å‰ç«¯æ¥å£**: å·²å­˜åœ¨
- `GET /api/stocks/{ts_code}/daily?start_date=20231101&end_date=20231130&limit=60`

**å‰ç«¯å±•ç¤º**:
- Kçº¿å›¾è¡¨ï¼ˆRechartsï¼‰
- æˆäº¤é‡æŸ±çŠ¶å›¾
- ç§»åŠ¨å¹³å‡çº¿

---

### 2.3 æ¯æ—¥åŸºæœ¬æŒ‡æ ‡ï¼ˆæ ¸å¿ƒï¼ï¼‰

**Tushareæ¥å£**: `pro.daily_basic()`

**åŠŸèƒ½**:
- æ¢æ‰‹ç‡
- é‡æ¯”
- å¸‚ç›ˆç‡
- å¸‚å€¼
- **æœ€é€‚åˆåšå¼‚åŠ¨æ£€æµ‹**

**åç«¯éœ€è¦å®ç°**:
```python
# app/services/tushare_service.py
def get_daily_basic(self, ts_code=None, trade_date=None):
    """
    è·å–æ¯æ—¥æŒ‡æ ‡
    
    å‚æ•°:
        ts_code: è‚¡ç¥¨ä»£ç ï¼ˆå¯é€‰ï¼Œä¸å¡«è¿”å›æ‰€æœ‰ï¼‰
        trade_date: äº¤æ˜“æ—¥æœŸï¼ˆå¯é€‰ï¼Œé»˜è®¤æœ€æ–°ï¼‰
    """
    if not trade_date:
        trade_date = datetime.now().strftime('%Y%m%d')
    
    df = self.pro.daily_basic(
        ts_code=ts_code,
        trade_date=trade_date,
        fields='ts_code,trade_date,close,turnover_rate,turnover_rate_f,volume_ratio,pe,pe_ttm,pb,ps,total_share,float_share,total_mv,circ_mv'
    )
    return df.to_dict('records')
```

**æ–°å¢å‰ç«¯æ¥å£**:
- `GET /api/stocks/daily-basic?trade_date=20231201` - è·å–å…¨å¸‚åœºæŒ‡æ ‡
- `GET /api/stocks/{ts_code}/basic?trade_date=20231201` - è·å–å•åªè‚¡ç¥¨æŒ‡æ ‡

**å‰ç«¯å±•ç¤º**:
- å®æ—¶ç›‘æ§é¡µé¢
- å¼‚åŠ¨è‚¡ç¥¨åˆ—è¡¨
- æ¢æ‰‹ç‡æ’è¡Œ
- é‡æ¯”æ’è¡Œ

---

## ğŸš¨ ç¬¬ä¸‰é˜¶æ®µï¼šå¼‚åŠ¨æ£€æµ‹ä¸é¢„è­¦ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

### 3.1 å¼‚åŠ¨æ£€æµ‹è§„åˆ™

**åŸºäº `daily_basic` æ•°æ®**:

```python
# app/services/anomaly_detection_service.py
class AnomalyDetectionService:
    
    def detect_high_turnover(self, df, threshold=10):
        """æ¢æ‰‹ç‡å¼‚åŠ¨"""
        return df[df['turnover_rate'] > threshold]
    
    def detect_volume_ratio(self, df, threshold=2):
        """é‡æ¯”å¼‚åŠ¨"""
        return df[df['volume_ratio'] > threshold]
    
    def detect_price_change(self, df, up_threshold=5, down_threshold=-5):
        """ä»·æ ¼å¼‚åŠ¨"""
        # éœ€è¦å¯¹æ¯”å‰ä¸€å¤©çš„æ”¶ç›˜ä»·
        return df[(df['pct_chg'] > up_threshold) | (df['pct_chg'] < down_threshold)]
    
    def detect_market_value_change(self, df, threshold=10):
        """å¸‚å€¼å¼‚åŠ¨"""
        # å¸‚å€¼å¤§å¹…å˜åŒ–
        pass
```

**æ–°å¢APIæ¥å£**:
- `GET /api/anomaly/high-turnover?threshold=10` - é«˜æ¢æ‰‹ç‡
- `GET /api/anomaly/volume-ratio?threshold=2` - é«˜é‡æ¯”
- `GET /api/anomaly/price-change?up=5&down=-5` - ä»·æ ¼å¼‚åŠ¨

**å‰ç«¯å±•ç¤º**:
- å¼‚åŠ¨é¢„è­¦å¡ç‰‡
- å®æ—¶å¼‚åŠ¨åˆ—è¡¨
- å¼‚åŠ¨ç±»å‹åˆ†ç±»ï¼ˆæ¢æ‰‹ç‡/é‡æ¯”/ä»·æ ¼ï¼‰

---

### 3.2 é¢„è­¦è§„åˆ™ç®¡ç†

**å·²æœ‰çš„APIæ¥å£**: âœ…
- `GET /api/rules` - è·å–è§„åˆ™åˆ—è¡¨
- `POST /api/rules` - åˆ›å»ºè§„åˆ™
- `PUT /api/rules/{id}` - æ›´æ–°è§„åˆ™
- `DELETE /api/rules/{id}` - åˆ é™¤è§„åˆ™
- `GET /api/alerts` - è·å–é¢„è­¦è®°å½•

**éœ€è¦å®ç°åç«¯é€»è¾‘**:
```python
# app/services/alert_service.py
class AlertService:
    
    def check_rules(self, stock_data, rules):
        """æ£€æŸ¥è‚¡ç¥¨æ•°æ®æ˜¯å¦è§¦å‘è§„åˆ™"""
        alerts = []
        
        for rule in rules:
            if not rule.enabled:
                continue
            
            if rule.rule_type == 'price_change':
                # æ£€æŸ¥æ¶¨è·Œå¹…
                if self._check_price_change(stock_data, rule):
                    alerts.append(self._create_alert(stock_data, rule))
            
            elif rule.rule_type == 'volume_spike':
                # æ£€æŸ¥æˆäº¤é‡å¼‚åŠ¨
                if self._check_volume_spike(stock_data, rule):
                    alerts.append(self._create_alert(stock_data, rule))
            
            elif rule.rule_type == 'turnover_rate':
                # æ£€æŸ¥æ¢æ‰‹ç‡
                if self._check_turnover_rate(stock_data, rule):
                    alerts.append(self._create_alert(stock_data, rule))
        
        return alerts
```

**å‰ç«¯å±•ç¤º**:
- è§„åˆ™é…ç½®è¡¨å•
- è§„åˆ™åˆ—è¡¨
- å¯ç”¨/ç¦ç”¨å¼€å…³
- é¢„è­¦å†å²è®°å½•

---

## ğŸ“ˆ ç¬¬å››é˜¶æ®µï¼šæ•°æ®å¯è§†åŒ–

### 4.1 Kçº¿å›¾è¡¨

**æ•°æ®æ¥æº**: `pro.daily()`

**å›¾è¡¨ç»„ä»¶**: Recharts

**åŠŸèƒ½**:
- æ—¥Kçº¿/å‘¨Kçº¿/æœˆKçº¿åˆ‡æ¢
- MACDæŒ‡æ ‡
- KDJæŒ‡æ ‡
- æˆäº¤é‡
- ç§»åŠ¨å¹³å‡çº¿ï¼ˆMA5/MA10/MA20ï¼‰

**å‰ç«¯å®ç°**:
```jsx
// src/components/StockChart.jsx
import { LineChart, Line, CandlestickChart } from 'recharts';

function StockChart({ tsCode }) {
  const [klineData, setKlineData] = useState([]);
  
  useEffect(() => {
    // è·å–Kçº¿æ•°æ®
    getStockDailyData(tsCode, { limit: 60 }).then(data => {
      setKlineData(data);
    });
  }, [tsCode]);
  
  return (
    <ResponsiveContainer>
      <LineChart data={klineData}>
        <Line dataKey="close" stroke="#8884d8" />
        <Line dataKey="ma5" stroke="#82ca9d" />
        <Line dataKey="ma10" stroke="#ffc658" />
      </LineChart>
    </ResponsiveContainer>
  );
}
```

---

### 4.2 å®æ—¶ç›‘æ§é¢æ¿

**æ•°æ®æ¥æº**: `pro.daily_basic()`

**æ›´æ–°é¢‘ç‡**: æ¯æ—¥æ”¶ç›˜åï¼ˆ18:00åï¼‰

**å±•ç¤ºå†…å®¹**:
- æ¶¨å¹…æ¦œ Top 10
- è·Œå¹…æ¦œ Top 10
- æ¢æ‰‹ç‡æ¦œ Top 10
- æˆäº¤é¢æ¦œ Top 10
- å¼‚åŠ¨è‚¡ç¥¨åˆ—è¡¨

---

## ğŸ”„ ç¬¬äº”é˜¶æ®µï¼šå®šæ—¶ä»»åŠ¡

### 5.1 æ•°æ®æ›´æ–°ä»»åŠ¡

**ä½¿ç”¨APSchedulerå®šæ—¶ä»»åŠ¡**:

```python
# app/tasks/data_update.py
from apscheduler.schedulers.background import BackgroundScheduler

scheduler = BackgroundScheduler()

@scheduler.scheduled_job('cron', hour=18, minute=30)
def update_daily_data():
    """æ¯æ—¥18:30æ›´æ–°æ•°æ®"""
    logger.info("å¼€å§‹æ›´æ–°æ¯æ—¥æ•°æ®...")
    
    # 1. è·å–äº¤æ˜“æ—¥å†ï¼Œåˆ¤æ–­ä»Šå¤©æ˜¯å¦äº¤æ˜“æ—¥
    trade_cal = tushare_service.get_trade_cal()
    if not is_trading_day(trade_cal):
        logger.info("ä»Šæ—¥éäº¤æ˜“æ—¥ï¼Œè·³è¿‡æ›´æ–°")
        return
    
    # 2. æ›´æ–°è‚¡ç¥¨åˆ—è¡¨ï¼ˆæ¯å‘¨ä¸€æ¬¡ï¼‰
    if datetime.now().weekday() == 0:
        update_stock_list()
    
    # 3. æ›´æ–°æ¯æ—¥è¡Œæƒ…
    daily_data = tushare_service.get_daily_basic()
    save_to_database(daily_data)
    
    # 4. æ‰§è¡Œå¼‚åŠ¨æ£€æµ‹
    anomalies = detect_anomalies(daily_data)
    
    # 5. æ£€æŸ¥é¢„è­¦è§„åˆ™
    check_alert_rules(anomalies)
    
    logger.info("æ¯æ—¥æ•°æ®æ›´æ–°å®Œæˆ")

scheduler.start()
```

---

## ğŸ“Š æ•°æ®å­˜å‚¨ç­–ç•¥

### 6.1 æ•°æ®åº“è¡¨è®¾è®¡

```sql
-- è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯è¡¨
CREATE TABLE stocks (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ts_code VARCHAR(10) UNIQUE,
    symbol VARCHAR(10),
    name VARCHAR(50),
    area VARCHAR(10),
    industry VARCHAR(20),
    market VARCHAR(10),
    list_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- æ—¥çº¿è¡Œæƒ…è¡¨
CREATE TABLE stock_daily (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ts_code VARCHAR(10),
    trade_date DATE,
    open DECIMAL(10,2),
    high DECIMAL(10,2),
    low DECIMAL(10,2),
    close DECIMAL(10,2),
    pre_close DECIMAL(10,2),
    change_amount DECIMAL(10,2),
    pct_chg DECIMAL(6,2),
    vol BIGINT,
    amount DECIMAL(15,2),
    INDEX idx_ts_code_date (ts_code, trade_date)
);

-- æ¯æ—¥æŒ‡æ ‡è¡¨
CREATE TABLE stock_daily_basic (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ts_code VARCHAR(10),
    trade_date DATE,
    close DECIMAL(10,2),
    turnover_rate DECIMAL(6,2),
    volume_ratio DECIMAL(6,2),
    pe DECIMAL(10,2),
    pb DECIMAL(10,2),
    total_mv DECIMAL(15,2),
    circ_mv DECIMAL(15,2),
    INDEX idx_ts_code_date (ts_code, trade_date)
);

-- å¼‚åŠ¨è®°å½•è¡¨
CREATE TABLE anomaly_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ts_code VARCHAR(10),
    anomaly_type VARCHAR(20),
    trade_date DATE,
    metric_value DECIMAL(10,2),
    threshold_value DECIMAL(10,2),
    severity VARCHAR(10),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## ğŸ¯ å®ç°ä¼˜å…ˆçº§

### P0 - ç«‹å³å®ç°ï¼ˆæœ¬å‘¨ï¼‰
1. âœ… æ•°æ®æºé…ç½®ï¼ˆå·²å®Œæˆï¼‰
2. ğŸ”„ è‚¡ç¥¨åˆ—è¡¨è·å–
3. ğŸ”„ æ—¥çº¿è¡Œæƒ…è·å–
4. ğŸ”„ å‰ç«¯Kçº¿å›¾è¡¨å±•ç¤º

### P1 - çŸ­æœŸå®ç°ï¼ˆä¸‹å‘¨ï¼‰
1. æ¯æ—¥æŒ‡æ ‡è·å–
2. å¼‚åŠ¨æ£€æµ‹é€»è¾‘
3. é¢„è­¦è§„åˆ™ç®¡ç†
4. å®æ—¶ç›‘æ§é¢æ¿

### P2 - ä¸­æœŸå®ç°ï¼ˆä¸‹ä¸‹å‘¨ï¼‰
1. å®šæ—¶ä»»åŠ¡
2. æ•°æ®åº“å­˜å‚¨
3. å†å²æ•°æ®å›æµ‹
4. WebSocketå®æ—¶æ¨é€

### P3 - é•¿æœŸå®ç°ï¼ˆä¸€ä¸ªæœˆå†…ï¼‰
1. æ›´å¤šæŠ€æœ¯æŒ‡æ ‡
2. è‡ªå®šä¹‰ç­–ç•¥
3. å›æµ‹ç³»ç»Ÿ
4. æŠ¥è¡¨å¯¼å‡º

---

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

### APIè°ƒç”¨é¢‘ç‡æ§åˆ¶
```python
import time
from functools import wraps

def rate_limit(calls_per_minute=60):
    """APIè°ƒç”¨é¢‘ç‡é™åˆ¶è£…é¥°å™¨"""
    min_interval = 60.0 / calls_per_minute
    last_called = [0.0]
    
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            elapsed = time.time() - last_called[0]
            left_to_wait = min_interval - elapsed
            if left_to_wait > 0:
                time.sleep(left_to_wait)
            ret = func(*args, **kwargs)
            last_called[0] = time.time()
            return ret
        return wrapper
    return decorator

@rate_limit(calls_per_minute=60)
def get_stock_data(ts_code):
    return tushare_service.get_stock_basic()
```

### æ•°æ®ç¼“å­˜ç­–ç•¥
```python
from functools import lru_cache
from datetime import datetime, timedelta

@lru_cache(maxsize=100)
def get_stock_list_cached():
    """ç¼“å­˜è‚¡ç¥¨åˆ—è¡¨ï¼Œæ¯å¤©æ›´æ–°ä¸€æ¬¡"""
    return tushare_service.get_stock_list()

# Redisç¼“å­˜
def get_daily_data_with_cache(ts_code, trade_date):
    cache_key = f"daily:{ts_code}:{trade_date}"
    
    # å…ˆä»ç¼“å­˜è·å–
    cached_data = redis_client.get(cache_key)
    if cached_data:
        return json.loads(cached_data)
    
    # ç¼“å­˜æœªå‘½ä¸­ï¼Œä»Tushareè·å–
    data = tushare_service.get_daily_data(ts_code, trade_date)
    
    # å­˜å…¥ç¼“å­˜ï¼Œä¿å­˜24å°æ—¶
    redis_client.setex(cache_key, 86400, json.dumps(data))
    
    return data
```

---

## ğŸ“ æ€»ç»“

**å…è´¹ç‰ˆTushareå®Œå…¨å¯ä»¥å®ç°**:
- âœ… è‚¡ç¥¨åˆ—è¡¨ç®¡ç†
- âœ… æ—¥çº¿Kçº¿å›¾è¡¨
- âœ… å¼‚åŠ¨æ£€æµ‹ï¼ˆæ¢æ‰‹ç‡ã€é‡æ¯”ã€æ¶¨è·Œå¹…ï¼‰
- âœ… é¢„è­¦è§„åˆ™ç®¡ç†
- âœ… å†å²æ•°æ®å›æµ‹

**é™åˆ¶**:
- âŒ æ— å®æ—¶è¡Œæƒ…ï¼ˆåªæœ‰æ—¥çº¿çº§åˆ«ï¼‰
- âŒ æ— åˆ†é’Ÿæ•°æ®
- âŒ æ— èµ„é‡‘æµå‘æ•°æ®ï¼ˆéœ€è¦2000ç§¯åˆ†ï¼‰

**æ¨èä½¿ç”¨ç­–ç•¥**:
1. æ¯æ—¥æ”¶ç›˜åï¼ˆ18:00-19:00ï¼‰æ‰¹é‡æ›´æ–°æ•°æ®
2. ä½¿ç”¨Redisç¼“å­˜å‡å°‘APIè°ƒç”¨
3. æ•°æ®åº“å­˜å‚¨å†å²æ•°æ®
4. å‰ç«¯å±•ç¤ºç¼“å­˜æ•°æ®ï¼Œæå‡å“åº”é€Ÿåº¦

---

**æ¥ä¸‹æ¥çš„å·¥ä½œ**:
1. å®ç°è‚¡ç¥¨åˆ—è¡¨API
2. å®ç°æ—¥çº¿è¡Œæƒ…API
3. å‰ç«¯å¯¹æ¥è¿™äº›API
4. å®ç°Kçº¿å›¾è¡¨ç»„ä»¶
