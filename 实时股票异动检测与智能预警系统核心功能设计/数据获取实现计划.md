# Tushare Pro 数据接口说明

## 📋 概述

Tushare Pro 是一个金融数据平台，提供丰富的股票、基金、期货等金融数据接口。

**官方文档**: https://tushare.pro/document/2

---

## 🎯 我们系统需要的核心数据

### 1. **股票列表数据** ✅ 已实现

**接口**: `pro.stock_basic()`

**用途**: 获取所有A股上市公司基本信息

**参数**:
```python
df = pro.stock_basic(
    exchange='',        # 交易所: SSE上交所, SZSE深交所
    list_status='L',    # 上市状态: L上市, D退市, P暂停上市
    fields='ts_code,symbol,name,area,industry,list_date'
)
```

**返回字段**:
- `ts_code`: 股票代码（如 000001.SZ）
- `symbol`: 股票代码（如 000001）
- `name`: 股票名称
- `area`: 地域
- `industry`: 行业
- `market`: 市场类型（主板/创业板/科创板）
- `list_date`: 上市日期

**示例返回**:
```
ts_code    symbol  name    area  industry      list_date
000001.SZ  000001  平安银行  深圳   银行           19910403
000002.SZ  000002  万科A    深圳   房地产         19910129
```

---

### 2. **日线行情数据** ✅ 已实现

**接口**: `pro.daily()`

**用途**: 获取股票每日K线数据

**参数**:
```python
df = pro.daily(
    ts_code='000001.SZ',      # 股票代码
    trade_date='20231201',    # 交易日期（可选）
    start_date='20231101',    # 开始日期
    end_date='20231130'       # 结束日期
)
```

**返回字段**:
- `ts_code`: 股票代码
- `trade_date`: 交易日期
- `open`: 开盘价
- `high`: 最高价
- `low`: 最低价
- `close`: 收盘价
- `pre_close`: 昨收价
- `change`: 涨跌额
- `pct_chg`: 涨跌幅（%）
- `vol`: 成交量（手）
- `amount`: 成交额（千元）

**权限**: 免费用户可获取近3年日线数据

---

### 3. **实时行情数据** ⏳ 待实现

**接口**: `ts.realtime_quote()`

**用途**: 获取股票实时行情（分钟级）

**注意**: 
- 需要较高权限积分（2000分以上）
- 免费用户可能无法访问
- 替代方案：使用`pro.daily()`获取最新日线数据

**替代方案 - 最新日线**:
```python
# 获取今天的数据
df = pro.daily(trade_date='20231201')
```

---

### 4. **分钟级行情数据** ⏳ 可选

**接口**: `pro.stk_mins()`

**用途**: 获取1分钟/5分钟K线数据

**参数**:
```python
df = pro.stk_mins(
    ts_code='000001.SZ',
    freq='1min',              # 频率: 1min, 5min, 15min, 30min, 60min
    start_date='20231201',
    end_date='20231201'
)
```

**权限要求**: 需要5000积分以上

**对于免费用户**: 不可用，建议使用日线数据

---

### 5. **涨跌停数据** 📊 推荐

**接口**: `pro.limit_list()`

**用途**: 获取每日涨跌停股票统计

**参数**:
```python
df = pro.limit_list(
    trade_date='20231201',    # 交易日期
    limit_type='U'            # U涨停, D跌停
)
```

**返回字段**:
- `ts_code`: 股票代码
- `trade_date`: 交易日期
- `industry`: 行业
- `close`: 收盘价
- `pct_chg`: 涨跌幅
- `limit_times`: 涨停次数

**权限**: 免费用户可用

---

### 6. **龙虎榜数据** 📊 推荐

**接口**: `pro.top_list()`

**用途**: 获取沪深龙虎榜数据

**参数**:
```python
df = pro.top_list(
    trade_date='20231201'     # 交易日期
)
```

**返回字段**:
- `ts_code`: 股票代码
- `name`: 股票名称
- `close`: 收盘价
- `pct_chg`: 涨跌幅
- `amount`: 龙虎榜成交额
- `net_amount`: 龙虎榜净买额
- `buy`: 龙虎榜买入额
- `sell`: 龙虎榜卖出额

**权限**: 需要120积分

---

### 7. **股票每日指标** 📈 推荐

**接口**: `pro.daily_basic()`

**用途**: 获取股票每日重要基本指标

**参数**:
```python
df = pro.daily_basic(
    ts_code='000001.SZ',      # 股票代码
    trade_date='20231201'     # 交易日期
)
```

**返回字段**:
- `ts_code`: 股票代码
- `trade_date`: 交易日期
- `close`: 收盘价
- `turnover_rate`: 换手率（%）
- `turnover_rate_f`: 换手率（自由流通股）
- `volume_ratio`: 量比
- `pe`: 市盈率（总市值/净利润）
- `pe_ttm`: 市盈率（TTM）
- `pb`: 市净率（总市值/净资产）
- `ps`: 市销率
- `ps_ttm`: 市销率（TTM）
- `total_share`: 总股本（万股）
- `float_share`: 流通股本（万股）
- `free_share`: 自由流通股本（万股）
- `total_mv`: 总市值（万元）
- `circ_mv`: 流通市值（万元）

**权限**: 免费用户可用

**非常适合异动检测**：
- 换手率突增
- 量比异常
- 市值变化

---

### 8. **资金流向数据** 💰 推荐

**接口**: `pro.moneyflow()`

**用途**: 获取个股资金流向

**参数**:
```python
df = pro.moneyflow(
    ts_code='000001.SZ',
    start_date='20231101',
    end_date='20231130'
)
```

**返回字段**:
- `ts_code`: 股票代码
- `trade_date`: 交易日期
- `buy_sm_vol`: 小单买入量
- `buy_sm_amount`: 小单买入金额
- `sell_sm_vol`: 小单卖出量
- `sell_sm_amount`: 小单卖出金额
- `buy_md_vol`: 中单买入量
- `buy_md_amount`: 中单买入金额
- `sell_md_vol`: 中单卖出量
- `sell_md_amount`: 中单卖出金额
- `buy_lg_vol`: 大单买入量
- `buy_lg_amount`: 大单买入金额
- `sell_lg_vol`: 大单卖出量
- `sell_lg_amount`: 大单卖出金额
- `buy_elg_vol`: 特大单买入量
- `buy_elg_amount`: 特大单买入金额
- `sell_elg_vol`: 特大单卖出量
- `sell_elg_amount`: 特大单卖出金额
- `net_mf_vol`: 净流入量
- `net_mf_amount`: 净流入额

**权限**: 需要2000积分

**对异动检测非常有用**：
- 大单流入/流出
- 主力资金动向

---

### 9. **交易日历** 📅 基础

**接口**: `pro.trade_cal()`

**用途**: 获取交易所日历（交易日/休市日）

**参数**:
```python
df = pro.trade_cal(
    exchange='SSE',           # 交易所: SSE上交所, SZSE深交所
    start_date='20231101',
    end_date='20231130'
)
```

**返回字段**:
- `exchange`: 交易所
- `cal_date`: 日期
- `is_open`: 是否交易（0休市, 1交易）
- `pretrade_date`: 上一个交易日

**权限**: 免费用户可用

---

## 🔑 权限说明

Tushare Pro 采用积分制度：

| 积分等级 | 获取方式 | 可用接口 |
|---------|---------|---------|
| **0分（免费）** | 注册即可 | 股票列表、日线行情、每日指标、交易日历 |
| **120分** | 完善资料、分享 | + 龙虎榜数据 |
| **2000分** | 捐赠或积累 | + 资金流向、实时行情（受限） |
| **5000分+** | 捐赠 | + 分钟数据、tick数据 |

**获取积分**:
1. 完善个人资料：+50分
2. 每日签到：+1分
3. 分享到社交媒体：+20分
4. 捐赠：100元=2000分

---

## 💡 推荐的数据获取方案

### 方案一：免费版（0积分）

**可用数据**:
- ✅ 股票列表 (`stock_basic`)
- ✅ 日线行情 (`daily`)
- ✅ 每日指标 (`daily_basic`) - **推荐用于异动检测**
- ✅ 交易日历 (`trade_cal`)

**异动检测策略**:
```python
# 1. 获取昨天的数据
df_yesterday = pro.daily_basic(trade_date='20231130')

# 2. 获取今天的数据
df_today = pro.daily_basic(trade_date='20231201')

# 3. 计算异动指标
# - 换手率突增：今天换手率 > 昨天换手率 * 2
# - 量比异常：volume_ratio > 2
# - 价格异动：pct_chg > 5% 或 < -5%
```

**优点**: 完全免费，适合个人学习
**缺点**: 无实时数据，只能获取日线级别

---

### 方案二：基础版（120积分）

**额外可用**:
- ✅ 龙虎榜数据 (`top_list`) - 捕捉主力动向
- ✅ 涨跌停数据 (`limit_list`)

**异动检测增强**:
- 龙虎榜席位分析
- 涨停板监控

**获取方式**: 完善资料 + 分享，约1-2天可达到

---

### 方案三：专业版（2000积分+）

**额外可用**:
- ✅ 资金流向 (`moneyflow`) - **最强异动检测**
- ✅ 实时行情（受限）
- ✅ 更多财务数据

**异动检测**:
- 主力资金流入流出
- 大单异动
- 更精准的预警

**获取方式**: 捐赠100元

---

## 📊 我们系统的数据获取建议

### 阶段一：基础功能（免费版）

```python
# 1. 股票列表 - 系统初始化
stocks = pro.stock_basic(list_status='L')

# 2. 每日更新行情
daily_data = pro.daily(trade_date='today')
daily_basic = pro.daily_basic(trade_date='today')

# 3. 历史K线（用于图表展示）
history = pro.daily(ts_code='000001.SZ', start_date='20231101', end_date='20231130')

# 4. 异动检测（基于每日指标）
# - 换手率 > 10%
# - 量比 > 2
# - 涨跌幅 > 5%
```

**可实现功能**:
- ✅ 股票列表展示
- ✅ K线图表
- ✅ 基础异动预警
- ✅ 价格预警
- ✅ 换手率预警

---

### 阶段二：增强功能（120积分）

```python
# 5. 龙虎榜监控
top_list = pro.top_list(trade_date='today')

# 6. 涨停监控
limit_up = pro.limit_list(trade_date='today', limit_type='U')
limit_down = pro.limit_list(trade_date='today', limit_type='D')
```

**新增功能**:
- ✅ 龙虎榜异动
- ✅ 涨跌停统计
- ✅ 主力动向追踪

---

### 阶段三：专业功能（2000积分+）

```python
# 7. 资金流向分析
moneyflow = pro.moneyflow(ts_code='000001.SZ', start_date='today')

# 8. 实时数据（如果可用）
realtime = ts.realtime_quote(ts_code='000001.SZ')
```

**新增功能**:
- ✅ 大单流入流出预警
- ✅ 主力资金异动
- ✅ 实时监控（如果可用）

---

## 🎯 数据更新频率

| 数据类型 | 更新频率 | 建议获取频率 |
|---------|---------|------------|
| 股票列表 | 不定期 | 每周1次 |
| 日线行情 | 每日收盘后 | 每日18:00后 |
| 每日指标 | 每日收盘后 | 每日18:00后 |
| 龙虎榜 | 每日收盘后 | 每日19:00后 |
| 资金流向 | 每日收盘后 | 每日19:00后 |

---

## ⚠️ API调用限制

**免费用户**:
- 每分钟调用次数：200次
- 每小时调用次数：不限（但单接口有限制）
- 单个接口限制：如 `stock_basic` 每小时1次

**注意**:
- 测试连接时不要频繁调用
- 使用数据库缓存，避免重复请求
- 遵循"先缓存，后调用"原则

---

## 💻 代码示例

### 完整的数据获取示例

```python
import tushare as ts
from datetime import datetime, timedelta

# 初始化
pro = ts.pro_api('YOUR_TOKEN')

# 1. 获取股票列表（每周更新一次）
def get_stock_list():
    df = pro.stock_basic(
        list_status='L',
        fields='ts_code,symbol,name,area,industry,market,list_date'
    )
    return df

# 2. 获取今日行情
def get_today_market():
    today = datetime.now().strftime('%Y%m%d')
    df = pro.daily_basic(trade_date=today)
    return df

# 3. 异动检测
def detect_anomaly(df):
    # 换手率异动
    high_turnover = df[df['turnover_rate'] > 10]
    
    # 量比异动
    high_volume_ratio = df[df['volume_ratio'] > 2]
    
    # 价格异动
    price_change = df[(df['close'] > df['close'].shift(1) * 1.05) | 
                      (df['close'] < df['close'].shift(1) * 0.95)]
    
    return {
        'high_turnover': high_turnover,
        'high_volume_ratio': high_volume_ratio,
        'price_change': price_change
    }

# 4. 获取历史K线
def get_history_kline(ts_code, days=60):
    end_date = datetime.now()
    start_date = end_date - timedelta(days=days)
    
    df = pro.daily(
        ts_code=ts_code,
        start_date=start_date.strftime('%Y%m%d'),
        end_date=end_date.strftime('%Y%m%d')
    )
    return df
```

---

## 📌 总结

**推荐起步方案**：
1. **使用免费版** - 完全够用于学习和个人使用
2. **重点使用**：
   - `stock_basic` - 股票列表
   - `daily` - 日线行情
   - `daily_basic` - **核心！用于异动检测**
3. **异动检测指标**：
   - 换手率（turnover_rate）
   - 量比（volume_ratio）
   - 涨跌幅（pct_chg）
   - 成交量（vol）

**后续升级**：
- 完善资料获取120积分 → 龙虎榜数据
- 如需更专业功能，考虑捐赠获取2000分

---

**官方资源**:
- 官网: https://tushare.pro
- 文档: https://tushare.pro/document/2
- 积分规则: https://tushare.pro/document/1?doc_id=13


# 📊 数据获取实现计划

## 🎯 基于Tushare免费版的实现方案

根据Tushare免费版的能力，我们可以实现以下功能：

---

## ✅ 第一阶段：基础数据（已完成）

### 1. 数据源配置 ✅
- [x] Tushare Token配置
- [x] 连接测试
- [x] 数据源激活

**已实现的API**:
- `GET /api/datasources` - 获取数据源列表
- `POST /api/datasources/{id}/test` - 测试连接
- `PUT /api/datasources/{id}` - 更新配置

---

## 🔄 第二阶段：股票列表与行情（待实现）

### 2.1 股票列表数据

**Tushare接口**: `pro.stock_basic()`

**功能**:
- 获取所有A股上市公司
- 支持按行业筛选
- 支持按地域筛选
- 支持市场类型筛选

**后端需要实现**:
```python
# app/services/tushare_service.py
def get_stock_list(self, exchange='', list_status='L', market=''):
    """
    获取股票列表
    
    参数:
        exchange: 交易所 (SSE/SZSE)
        list_status: 上市状态 (L上市/D退市/P暂停)
        market: 市场类型 (主板/创业板/科创板/北交所)
    """
    df = self.pro.stock_basic(
        exchange=exchange,
        list_status=list_status,
        market=market,
        fields='ts_code,symbol,name,area,industry,market,list_date'
    )
    return df.to_dict('records')
```

**前端接口**: 已存在
- `GET /api/stocks?industry=银行&area=深圳`

**前端展示**:
- 股票列表卡片
- 行业筛选
- 地域筛选
- 搜索功能

---

### 2.2 日线行情数据

**Tushare接口**: `pro.daily()`

**功能**:
- 获取K线数据
- 用于图表展示
- 历史回测

**后端需要实现**:
```python
# app/services/tushare_service.py
def get_daily_data(self, ts_code, start_date=None, end_date=None, limit=60):
    """
    获取日线行情
    
    参数:
        ts_code: 股票代码
        start_date: 开始日期 (YYYYMMDD)
        end_date: 结束日期 (YYYYMMDD)
        limit: 返回最近N天
    """
    if not start_date and not end_date:
        # 如果没有指定日期，返回最近limit天
        end_date = datetime.now().strftime('%Y%m%d')
        start_date = (datetime.now() - timedelta(days=limit*2)).strftime('%Y%m%d')
    
    df = self.pro.daily(
        ts_code=ts_code,
        start_date=start_date,
        end_date=end_date
    )
    return df.to_dict('records')
```

**前端接口**: 已存在
- `GET /api/stocks/{ts_code}/daily?start_date=20231101&end_date=20231130&limit=60`

**前端展示**:
- K线图表（Recharts）
- 成交量柱状图
- 移动平均线

---

### 2.3 每日基本指标（核心！）

**Tushare接口**: `pro.daily_basic()`

**功能**:
- 换手率
- 量比
- 市盈率
- 市值
- **最适合做异动检测**

**后端需要实现**:
```python
# app/services/tushare_service.py
def get_daily_basic(self, ts_code=None, trade_date=None):
    """
    获取每日指标
    
    参数:
        ts_code: 股票代码（可选，不填返回所有）
        trade_date: 交易日期（可选，默认最新）
    """
    if not trade_date:
        trade_date = datetime.now().strftime('%Y%m%d')
    
    df = self.pro.daily_basic(
        ts_code=ts_code,
        trade_date=trade_date,
        fields='ts_code,trade_date,close,turnover_rate,turnover_rate_f,volume_ratio,pe,pe_ttm,pb,ps,total_share,float_share,total_mv,circ_mv'
    )
    return df.to_dict('records')
```

**新增前端接口**:
- `GET /api/stocks/daily-basic?trade_date=20231201` - 获取全市场指标
- `GET /api/stocks/{ts_code}/basic?trade_date=20231201` - 获取单只股票指标

**前端展示**:
- 实时监控页面
- 异动股票列表
- 换手率排行
- 量比排行

---

## 🚨 第三阶段：异动检测与预警（核心功能）

### 3.1 异动检测规则

**基于 `daily_basic` 数据**:

```python
# app/services/anomaly_detection_service.py
class AnomalyDetectionService:
    
    def detect_high_turnover(self, df, threshold=10):
        """换手率异动"""
        return df[df['turnover_rate'] > threshold]
    
    def detect_volume_ratio(self, df, threshold=2):
        """量比异动"""
        return df[df['volume_ratio'] > threshold]
    
    def detect_price_change(self, df, up_threshold=5, down_threshold=-5):
        """价格异动"""
        # 需要对比前一天的收盘价
        return df[(df['pct_chg'] > up_threshold) | (df['pct_chg'] < down_threshold)]
    
    def detect_market_value_change(self, df, threshold=10):
        """市值异动"""
        # 市值大幅变化
        pass
```

**新增API接口**:
- `GET /api/anomaly/high-turnover?threshold=10` - 高换手率
- `GET /api/anomaly/volume-ratio?threshold=2` - 高量比
- `GET /api/anomaly/price-change?up=5&down=-5` - 价格异动

**前端展示**:
- 异动预警卡片
- 实时异动列表
- 异动类型分类（换手率/量比/价格）

---

### 3.2 预警规则管理

**已有的API接口**: ✅
- `GET /api/rules` - 获取规则列表
- `POST /api/rules` - 创建规则
- `PUT /api/rules/{id}` - 更新规则
- `DELETE /api/rules/{id}` - 删除规则
- `GET /api/alerts` - 获取预警记录

**需要实现后端逻辑**:
```python
# app/services/alert_service.py
class AlertService:
    
    def check_rules(self, stock_data, rules):
        """检查股票数据是否触发规则"""
        alerts = []
        
        for rule in rules:
            if not rule.enabled:
                continue
            
            if rule.rule_type == 'price_change':
                # 检查涨跌幅
                if self._check_price_change(stock_data, rule):
                    alerts.append(self._create_alert(stock_data, rule))
            
            elif rule.rule_type == 'volume_spike':
                # 检查成交量异动
                if self._check_volume_spike(stock_data, rule):
                    alerts.append(self._create_alert(stock_data, rule))
            
            elif rule.rule_type == 'turnover_rate':
                # 检查换手率
                if self._check_turnover_rate(stock_data, rule):
                    alerts.append(self._create_alert(stock_data, rule))
        
        return alerts
```

**前端展示**:
- 规则配置表单
- 规则列表
- 启用/禁用开关
- 预警历史记录

---

## 📈 第四阶段：数据可视化

### 4.1 K线图表

**数据来源**: `pro.daily()`

**图表组件**: Recharts

**功能**:
- 日K线/周K线/月K线切换
- MACD指标
- KDJ指标
- 成交量
- 移动平均线（MA5/MA10/MA20）

**前端实现**:
```jsx
// src/components/StockChart.jsx
import { LineChart, Line, CandlestickChart } from 'recharts';

function StockChart({ tsCode }) {
  const [klineData, setKlineData] = useState([]);
  
  useEffect(() => {
    // 获取K线数据
    getStockDailyData(tsCode, { limit: 60 }).then(data => {
      setKlineData(data);
    });
  }, [tsCode]);
  
  return (
    <ResponsiveContainer>
      <LineChart data={klineData}>
        <Line dataKey="close" stroke="#8884d8" />
        <Line dataKey="ma5" stroke="#82ca9d" />
        <Line dataKey="ma10" stroke="#ffc658" />
      </LineChart>
    </ResponsiveContainer>
  );
}
```

---

### 4.2 实时监控面板

**数据来源**: `pro.daily_basic()`

**更新频率**: 每日收盘后（18:00后）

**展示内容**:
- 涨幅榜 Top 10
- 跌幅榜 Top 10
- 换手率榜 Top 10
- 成交额榜 Top 10
- 异动股票列表

---

## 🔄 第五阶段：定时任务

### 5.1 数据更新任务

**使用APScheduler定时任务**:

```python
# app/tasks/data_update.py
from apscheduler.schedulers.background import BackgroundScheduler

scheduler = BackgroundScheduler()

@scheduler.scheduled_job('cron', hour=18, minute=30)
def update_daily_data():
    """每日18:30更新数据"""
    logger.info("开始更新每日数据...")
    
    # 1. 获取交易日历，判断今天是否交易日
    trade_cal = tushare_service.get_trade_cal()
    if not is_trading_day(trade_cal):
        logger.info("今日非交易日，跳过更新")
        return
    
    # 2. 更新股票列表（每周一次）
    if datetime.now().weekday() == 0:
        update_stock_list()
    
    # 3. 更新每日行情
    daily_data = tushare_service.get_daily_basic()
    save_to_database(daily_data)
    
    # 4. 执行异动检测
    anomalies = detect_anomalies(daily_data)
    
    # 5. 检查预警规则
    check_alert_rules(anomalies)
    
    logger.info("每日数据更新完成")

scheduler.start()
```

---

## 📊 数据存储策略

### 6.1 数据库表设计

```sql
-- 股票基本信息表
CREATE TABLE stocks (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ts_code VARCHAR(10) UNIQUE,
    symbol VARCHAR(10),
    name VARCHAR(50),
    area VARCHAR(10),
    industry VARCHAR(20),
    market VARCHAR(10),
    list_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 日线行情表
CREATE TABLE stock_daily (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ts_code VARCHAR(10),
    trade_date DATE,
    open DECIMAL(10,2),
    high DECIMAL(10,2),
    low DECIMAL(10,2),
    close DECIMAL(10,2),
    pre_close DECIMAL(10,2),
    change_amount DECIMAL(10,2),
    pct_chg DECIMAL(6,2),
    vol BIGINT,
    amount DECIMAL(15,2),
    INDEX idx_ts_code_date (ts_code, trade_date)
);

-- 每日指标表
CREATE TABLE stock_daily_basic (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ts_code VARCHAR(10),
    trade_date DATE,
    close DECIMAL(10,2),
    turnover_rate DECIMAL(6,2),
    volume_ratio DECIMAL(6,2),
    pe DECIMAL(10,2),
    pb DECIMAL(10,2),
    total_mv DECIMAL(15,2),
    circ_mv DECIMAL(15,2),
    INDEX idx_ts_code_date (ts_code, trade_date)
);

-- 异动记录表
CREATE TABLE anomaly_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ts_code VARCHAR(10),
    anomaly_type VARCHAR(20),
    trade_date DATE,
    metric_value DECIMAL(10,2),
    threshold_value DECIMAL(10,2),
    severity VARCHAR(10),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 🎯 实现优先级

### P0 - 立即实现（本周）
1. ✅ 数据源配置（已完成）
2. 🔄 股票列表获取
3. 🔄 日线行情获取
4. 🔄 前端K线图表展示

### P1 - 短期实现（下周）
1. 每日指标获取
2. 异动检测逻辑
3. 预警规则管理
4. 实时监控面板

### P2 - 中期实现（下下周）
1. 定时任务
2. 数据库存储
3. 历史数据回测
4. WebSocket实时推送

### P3 - 长期实现（一个月内）
1. 更多技术指标
2. 自定义策略
3. 回测系统
4. 报表导出

---

## 💡 技术要点

### API调用频率控制
```python
import time
from functools import wraps

def rate_limit(calls_per_minute=60):
    """API调用频率限制装饰器"""
    min_interval = 60.0 / calls_per_minute
    last_called = [0.0]
    
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            elapsed = time.time() - last_called[0]
            left_to_wait = min_interval - elapsed
            if left_to_wait > 0:
                time.sleep(left_to_wait)
            ret = func(*args, **kwargs)
            last_called[0] = time.time()
            return ret
        return wrapper
    return decorator

@rate_limit(calls_per_minute=60)
def get_stock_data(ts_code):
    return tushare_service.get_stock_basic()
```

### 数据缓存策略
```python
from functools import lru_cache
from datetime import datetime, timedelta

@lru_cache(maxsize=100)
def get_stock_list_cached():
    """缓存股票列表，每天更新一次"""
    return tushare_service.get_stock_list()

# Redis缓存
def get_daily_data_with_cache(ts_code, trade_date):
    cache_key = f"daily:{ts_code}:{trade_date}"
    
    # 先从缓存获取
    cached_data = redis_client.get(cache_key)
    if cached_data:
        return json.loads(cached_data)
    
    # 缓存未命中，从Tushare获取
    data = tushare_service.get_daily_data(ts_code, trade_date)
    
    # 存入缓存，保存24小时
    redis_client.setex(cache_key, 86400, json.dumps(data))
    
    return data
```

---

## 📝 总结

**免费版Tushare完全可以实现**:
- ✅ 股票列表管理
- ✅ 日线K线图表
- ✅ 异动检测（换手率、量比、涨跌幅）
- ✅ 预警规则管理
- ✅ 历史数据回测

**限制**:
- ❌ 无实时行情（只有日线级别）
- ❌ 无分钟数据
- ❌ 无资金流向数据（需要2000积分）

**推荐使用策略**:
1. 每日收盘后（18:00-19:00）批量更新数据
2. 使用Redis缓存减少API调用
3. 数据库存储历史数据
4. 前端展示缓存数据，提升响应速度

---

**接下来的工作**:
1. 实现股票列表API
2. 实现日线行情API
3. 前端对接这些API
4. 实现K线图表组件


# 📦 数据缓存方案说明

## 🎯 为什么需要数据缓存？

**Tushare免费版限制**：
- `stock_basic` 接口：**每小时只能调用1次**
- `daily` 接口：每分钟调用次数有限制
- 频繁调用会被限制访问

**解决方案**：
- ✅ 数据存储到MySQL数据库
- ✅ 优先从数据库读取
- ✅ 数据库没有时才从Tushare获取
- ✅ 支持手动同步更新

---

## 📊 数据库表结构

### 1. 股票基本信息表 (`stock_basic`)

**已存在的表**:
```sql
CREATE TABLE stock_basic (
    ts_code VARCHAR(20) PRIMARY KEY COMMENT 'TS代码',
    symbol VARCHAR(20) COMMENT '股票代码',
    name VARCHAR(100) COMMENT '股票名称',
    area VARCHAR(100) COMMENT '地域',
    industry VARCHAR(100) COMMENT '所属行业',
    list_date DATE COMMENT '上市日期'
);
```

**用途**：
- 存储所有A股上市公司基本信息
- 支持按行业、地域筛选
- 约5000条数据

---

### 2. 日线数据表 (`stock_daily_history`)

**已存在的表**:
```sql
CREATE TABLE stock_daily_history (
    ts_code VARCHAR(20) COMMENT '股票代码',
    trade_date VARCHAR(8) COMMENT '交易日期YYYYMMDD',
    open DECIMAL(10,2) COMMENT '开盘价',
    high DECIMAL(10,2) COMMENT '最高价',
    low DECIMAL(10,2) COMMENT '最低价',
    close DECIMAL(10,2) COMMENT '收盘价',
    pre_close DECIMAL(10,2) COMMENT '昨收价',
    change DECIMAL(10,2) COMMENT '涨跌额',
    pct_chg DECIMAL(10,2) COMMENT '涨跌幅%',
    vol BIGINT COMMENT '成交量',
    amount DECIMAL(20,2) COMMENT '成交额',
    PRIMARY KEY (ts_code, trade_date)
);
```

**用途**：
- 存储股票每日K线数据
- 用于图表展示
- 约5000只股票 × 250天/年 = 125万条/年

---

## 🔄 数据缓存逻辑

### 流程图

```
前端请求股票列表
      ↓
   查询数据库
      ↓
  有数据？ ─→ 是 ─→ 返回数据库数据
      ↓
     否
      ↓
调用Tushare API
      ↓
  保存到数据库
      ↓
   返回数据
```

---

## 🚀 新增API接口

### 1. 获取股票列表（带缓存）

**接口**: `GET /api/stocks`

**参数**:
- `industry`: 行业筛选（可选）
- `area`: 地域筛选（可选）
- `page`: 页码（默认1）
- `page_size`: 每页数量（默认50）

**响应示例**:
```json
{
  "success": true,
  "data": [...],
  "total": 5000,
  "page": 1,
  "page_size": 50,
  "total_pages": 100,
  "source": "database"
}
```

**缓存逻辑**:
1. 优先从数据库查询
2. 如果数据库为空，自动调用Tushare同步
3. 同步后再次查询数据库
4. `source`字段表明数据来源

---

### 2. 手动同步股票列表

**接口**: `POST /api/stocks/sync`

**请求体**:
```json
{
  "force_update": false
}
```

**参数说明**:
- `force_update`: 是否强制更新（默认false）
  - `false`: 数据库有数据则跳过
  - `true`: 强制从Tushare重新获取

**响应示例**:
```json
{
  "success": true,
  "message": "同步成功",
  "added": 100,
  "updated": 4900,
  "total": 5000,
  "source": "tushare"
}
```

**使用场景**:
- 首次使用系统时调用一次
- 每周/每月更新一次股票列表
- 发现新股上市时

---

### 3. 获取日线数据（带缓存）

**接口**: `GET /api/stocks/{ts_code}/daily`

**参数**:
- `start_date`: 开始日期 YYYYMMDD（可选）
- `end_date`: 结束日期 YYYYMMDD（可选）
- `limit`: 返回条数（默认60）

**响应示例**:
```json
{
  "success": true,
  "data": [
    {
      "ts_code": "000001.SZ",
      "trade_date": "20230930",
      "open": 12.50,
      "high": 12.80,
      "low": 12.45,
      "close": 12.75,
      "pct_chg": 2.00,
      "vol": 150000,
      "amount": 187500
    }
  ],
  "source": "database"
}
```

**缓存逻辑**:
1. 优先从数据库查询
2. 如果数据库为空，自动调用Tushare获取
3. 保存到数据库后返回

---

### 4. 手动同步日线数据

**接口**: `POST /api/stocks/{ts_code}/daily/sync`

**请求体**:
```json
{
  "start_date": "20230901",
  "end_date": "20230930"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "同步成功",
  "added": 20,
  "source": "tushare"
}
```

**使用场景**:
- 补充历史数据
- 更新最新交易日数据

---

## 💡 使用建议

### 初次使用

**步骤1**: 同步股票列表
```bash
POST /api/stocks/sync
{
  "force_update": true
}
```

**步骤2**: 前端正常调用
```bash
GET /api/stocks?page=1&page_size=50
```

以后所有请求都会自动从数据库读取，**不会再调用Tushare**！

---

### 日常使用

**获取股票列表**:
```
GET /api/stocks?industry=银行
```
→ 直接从数据库读取，秒级响应 ⚡

**获取K线数据**:
```
GET /api/stocks/000001.SZ/daily?limit=30
```
→ 第一次会从Tushare获取并缓存  
→ 以后都从数据库读取 ⚡

---

### 定期更新

**每周更新股票列表**（新股上市）:
```bash
POST /api/stocks/sync
{
  "force_update": true
}
```

**每日更新K线数据**（可选，定时任务）:
```bash
POST /api/stocks/000001.SZ/daily/sync
{
  "start_date": "20230930",
  "end_date": "20230930"
}
```

---

## 🎯 优势总结

### ✅ 解决API限制
- 避免频繁调用Tushare
- 不受每小时1次的限制
- 数据响应更快

### ✅ 提升性能
- 数据库查询比API调用快10倍以上
- 支持分页、筛选
- 支持SQL聚合查询

### ✅ 数据持久化
- 历史数据永久保存
- 支持离线使用
- 可以做数据分析

### ✅ 灵活控制
- 可以选择何时更新
- 支持强制刷新
- 支持批量同步

---

## 📝 下一步工作

### 待实现功能

1. **定时任务**（APScheduler）
   - 每日收盘后自动更新K线数据
   - 每周自动更新股票列表

2. **增量更新**
   - 只更新缺失的日期
   - 避免重复数据

3. **数据清理**
   - 定期清理过期数据
   - 压缩历史数据

4. **缓存优化**
   - Redis缓存热门数据
   - LRU淘汰机制

---

## 🔧 技术实现

### StockDataService核心方法

```python
class StockDataService:
    
    @staticmethod
    def get_stock_list(industry, area, page, page_size):
        """
        1. 查询数据库
        2. 如果为空，调用sync_stock_list()
        3. 返回分页数据
        """
    
    @staticmethod
    def sync_stock_list(force_update):
        """
        1. 从Tushare获取数据
        2. 批量插入/更新数据库
        3. 返回同步结果
        """
    
    @staticmethod
    def get_daily_data(ts_code, start_date, end_date, limit):
        """
        1. 查询数据库
        2. 如果为空，调用sync_daily_data()
        3. 返回历史数据
        """
    
    @staticmethod
    def sync_daily_data(ts_code, start_date, end_date):
        """
        1. 从Tushare获取数据
        2. 批量插入数据库（去重）
        3. 返回同步结果
        """
```

---

## ⚠️ 注意事项

1. **首次同步需要时间**
   - 5000只股票约需1-2分钟
   - 建议在后台进行

2. **API限制仍然存在**
   - 手动sync操作会调用Tushare
   - 不要频繁手动同步
   - 建议每周最多1次

3. **数据库空间**
   - 股票列表：约1MB
   - 日线数据：约100MB/年
   - 总计不会超过500MB

4. **数据一致性**
   - 数据库数据可能有延迟
   - 重要决策建议手动sync确认

---

**完成时间**: 2025年9月30日  
**版本**: v1.0  
**状态**: ✅ 已实现
