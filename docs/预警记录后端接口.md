 预警记录功能后端接口文档

  📋 功能概述

  预警记录功能为股票异动检测与智能预警系统提供了完整的预警历史记录管理能力，包括预警记录的创建、查询、更新、状态管理
  和统计分析等功能。

  🔧 后端接口详细说明

  1. 预警记录基础管理

  1.1 获取预警记录列表

  接口地址: GET /api/alerts
  代码位置: app/api/alert_routes.py:262-323
  功能描述: 获取预警记录列表，支持多种过滤条件和分页
  请求参数:
  {
    "ts_code": "股票代码过滤（可选）",
    "alert_type": "预警类型过滤（可选）",
    "alert_level": "预警级别过滤（可选）",
    "alert_status": "预警状态过滤（可选）",
    "trigger_source": "触发源过滤（可选）",
    "rule_id": "预警规则ID过滤（可选）",
    "start_date": "开始日期（ISO格式，可选）",
    "end_date": "结束日期（ISO格式，可选）",
    "page": "页码（默认1）",
    "per_page": "每页条数（默认50，最大100）",
    "order_by": "排序字段（默认created_at）",
    "order_dir": "排序方向（asc/desc，默认desc）",
    "include_rule": "是否包含关联规则信息（true/false，默认false）"
  }
  响应示例:
  {
    "success": true,
    "data": {
      "records": [...],
      "pagination": {
        "page": 1,
        "per_page": 20,
        "total": 100,
        "pages": 5,
        "has_next": true,
        "has_prev": false
      }
    }
  }

  1.2 获取单个预警记录详情

  接口地址: GET /api/alerts/{id}
  代码位置: app/api/alert_routes.py:392-411
  功能描述: 根据ID获取单个预警记录的详细信息，包含关联规则信息

  1.3 创建预警记录

  接口地址: POST /api/alerts
  代码位置: app/api/alert_routes.py:326-389
  功能描述: 手动创建预警记录，支持自动触发和手动触发两种方式
  请求体:
  {
    "ts_code": "股票代码（必需）",
    "alert_type": "预警类型（必需）",
    "alert_level": "预警级别（必需）",
    "alert_message": "预警消息（必需）",
    "rule_id": "关联预警规则ID（可选）",
    "risk_value": "风险值（可选）",
    "threshold_value": "阈值（可选）",
    "current_price": "当前价格（可选）",
    "position_size": "持仓数量（可选）",
    "portfolio_weight": "组合权重（可选）",
    "trigger_source": "触发源（默认manual）",
    "extra_data": "扩展数据JSON（可选）"
  }

  1.4 更新预警记录

  接口地址: PUT /api/alerts/{id}
  代码位置: app/api/alert_routes.py:414-450
  功能描述: 更新预警记录信息（不包含状态字段）

  1.5 删除预警记录

  接口地址: DELETE /api/alerts/{id}
  代码位置: app/api/alert_routes.py:453-473
  功能描述: 永久删除预警记录

  2. 预警记录状态管理

  2.1 解决预警

  接口地址: POST /api/alerts/{id}/resolve
  代码位置: app/api/alert_routes.py:476-502
  功能描述: 将预警记录标记为已解决状态
  请求体:
  {
    "resolution_note": "解决备注（可选）"
  }

  2.2 忽略预警

  接口地址: POST /api/alerts/{id}/ignore
  代码位置: app/api/alert_routes.py:505-531
  功能描述: 将预警记录标记为已忽略状态
  请求体:
  {
    "ignore_note": "忽略备注（可选）"
  }

  2.3 重新激活预警

  接口地址: POST /api/alerts/{id}/reactivate
  代码位置: app/api/alert_routes.py:534-557
  功能描述: 将已解决或已忽略的预警记录重新激活

  3. 批量操作功能

  3.1 批量解决预警

  接口地址: POST /api/alerts/batch/resolve
  代码位置: app/api/alert_routes.py:560-586
  功能描述: 批量解决多个预警记录
  请求体:
  {
    "alert_ids": [1, 2, 3],
    "resolution_note": "批量解决备注（可选）"
  }

  3.2 批量忽略预警

  接口地址: POST /api/alerts/batch/ignore
  代码位置: app/api/alert_routes.py:589-615
  功能描述: 批量忽略多个预警记录

  4. 统计和导出功能

  4.1 获取预警统计信息

  接口地址: GET /api/alerts/stats
  代码位置: app/api/alert_routes.py:620-639
  功能描述: 获取多维度的预警统计信息
  请求参数:
  {
    "days": "统计天数（默认30）",
    "ts_code": "股票代码过滤（可选）"
  }
  响应数据:
  {
    "period_days": 30,
    "total_alerts": 150,
    "active_alerts": 25,
    "resolved_alerts": 100,
    "ignored_alerts": 25,
    "by_level": {"low": 30, "medium": 60, "high": 40, "critical": 20},
    "by_type": {"price_threshold": 80, "volume_ratio": 30, ...},
    "by_status": {"active": 25, "resolved": 100, "ignored": 25},
    "by_source": {"auto": 120, "manual": 30},
    "trend": [{"date": "2025-11-01", "count": 5}, ...]
  }

  4.2 导出预警记录

  接口地址: POST /api/alerts/export
  代码位置: app/api/alert_routes.py:642-719
  功能描述: 导出预警记录数据，支持CSV和JSON格式

  4.3 获取预警配置选项

  接口地址: GET /api/alerts/options
  代码位置: app/api/alert_routes.py:722-747
  功能描述: 获取预警记录的配置选项和枚举值
  响应数据:
  {
    "alert_types": {"price_threshold": "价格阈值", ...},
    "alert_levels": {"low": "低级预警", ...},
    "alert_statuses": {"active": "活跃", ...},
    "trigger_sources": {"auto": "自动触发", ...},
    "order_fields": [...]
  }

  5. 预警规则相关接口（复用）

  5.1 获取预警统计信息（包含规则统计）

  接口地址: GET /api/alert/stats
  代码位置: app/api/alert_routes.py:752-791
  功能描述: 获取预警规则和记录的综合统计信息

  🗄️ 数据模型

  RiskAlert模型

  文件位置: app/models/risk_alert.py

  主要字段:
  - id: 预警记录ID（主键）
  - ts_code: 股票代码
  - alert_type: 预警类型
  - alert_level: 预警级别
  - alert_message: 预警消息
  - alert_status: 预警状态（active/resolved/ignored/pending）
  - rule_id: 关联预警规则ID（外键）
  - trigger_source: 触发源（auto/manual/api/system）
  - risk_value: 风险值（当前值）
  - threshold_value: 阈值
  - current_price: 当前价格
  - resolution_note: 解决备注
  - extra_data: 扩展数据JSON

  主要方法:
  - create_alert(): 创建预警记录
  - resolve_alert(): 解决预警
  - ignore_alert(): 忽略预警
  - reactivate_alert(): 重新激活预警
  - get_alerts(): 获取预警记录列表（支持过滤）
  - get_alert_stats(): 获取统计信息
  - bulk_resolve_alerts(): 批量解决
  - bulk_ignore_alerts(): 批量忽略

  🚀 业务逻辑

  预警触发引擎集成

  文件位置: app/services/alert_trigger_engine.py:353-399

  功能描述: 更新了预警触发引擎以支持新的RiskAlert模型
  - 自动预警记录创建时包含更多上下文信息
  - 关联预警规则ID
  - 详细的扩展数据记录

  数据库更新

  文件位置: init_alert_records_db.py

  功能描述: 数据库表结构自动更新脚本
  - 添加新字段：rule_id、trigger_source、alert_status等
  - 创建优化索引
  - 保持向后兼容性

  🔧 关键技术特性

  1. 状态管理

  - 完整的预警生命周期：创建 → 活跃 → 解决/忽略 → 重新激活
  - 状态转换逻辑严格，确保数据一致性

  2. 高级查询

  - 支持多条件组合过滤
  - 分页查询优化
  - 关联查询支持

  3. 批量操作

  - 批量解决和忽略功能
  - 事务处理确保数据完整性

  4. 统计分析

  - 多维度统计分析
  - 时间趋势分析
  - 实时数据汇总

  5. 导出功能

  - CSV和JSON格式支持
  - 自定义过滤条件导出

  📝 前端集成建议

  1. 预警记录列表页面

  - 使用 GET /api/alerts 获取数据
  - 支持多条件过滤和搜索
  - 实现状态标签和颜色区分
  - 支持批量选择和操作

  2. 预警详情页面

  - 使用 GET /api/alerts/{id} 获取详情
  - 显示完整预警信息和关联规则
  - 提供状态操作按钮（解决/忽略/重新激活）

  3. 统计仪表板

  - 使用 GET /api/alerts/stats 获取统计数据
  - 可视化展示统计图表
  - 实时更新数据

  4. 配置选项

  - 使用 GET /api/alerts/options 获取枚举值
  - 动态生成过滤器和下拉选项

  5. 数据导出

  - 使用 POST /api/alerts/export 导出数据
  - 支持自定义导出条件

  所有后端接口都已完整实现并通过测试，可以立即开始前端开发工作！