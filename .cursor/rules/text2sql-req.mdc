---
description: 
globs: 
alwaysApply: false
---
# Text2SQLåŠŸèƒ½å¼€å‘è®¡åˆ’

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°
åœ¨ç°æœ‰å¤šå› å­æ¨¡å‹ç³»ç»ŸåŸºç¡€ä¸Šï¼Œé›†æˆtext2sqlåŠŸèƒ½ï¼Œè®©ç”¨æˆ·é€šè¿‡è‡ªç„¶è¯­è¨€æŸ¥è¯¢è‚¡ç¥¨æ•°æ®å’Œå› å­ä¿¡æ¯ï¼Œå®ç°æ™ºèƒ½åŒ–çš„æ•°æ®åˆ†æå’ŒæŠ•èµ„å†³ç­–æ”¯æŒã€‚

## ğŸ¯ åŠŸèƒ½ç‚¹åˆ†æ

### 1. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

#### 1.1 è‡ªç„¶è¯­è¨€ç†è§£æ¨¡å— (NLU)
- [x] **æ„å›¾è¯†åˆ«** - è¯†åˆ«ç”¨æˆ·æŸ¥è¯¢æ„å›¾ï¼ˆè‚¡ç¥¨ç­›é€‰ã€å› å­åˆ†æã€æŠ€æœ¯æŒ‡æ ‡æŸ¥è¯¢ç­‰ï¼‰
- [x] **å®ä½“æŠ½å–** - æå–è‚¡ç¥¨ä»£ç ã€æ—¥æœŸã€æ•°å€¼èŒƒå›´ã€æŠ€æœ¯æŒ‡æ ‡åç§°ç­‰
- [x] **è¯­ä¹‰è§£æ** - ç†è§£å¤æ‚çš„æŸ¥è¯¢æ¡ä»¶å’Œé€»è¾‘å…³ç³»
- [x] **ä¸Šä¸‹æ–‡ç®¡ç†** - æ”¯æŒå¤šè½®å¯¹è¯å’Œä¸Šä¸‹æ–‡ç›¸å…³æŸ¥è¯¢

#### 1.2 SQLç”Ÿæˆæ¨¡å—
- [x] **æ¨¡æ¿åŒ¹é…** - åŸºäºé¢„å®šä¹‰æ¨¡æ¿ç”ŸæˆSQL
- [x] **åŠ¨æ€SQLæ„å»º** - æ ¹æ®è§£æç»“æœåŠ¨æ€æ„å»ºå¤æ‚æŸ¥è¯¢
- [x] **å¤šè¡¨å…³è”** - æ”¯æŒè·¨è¡¨æŸ¥è¯¢å’Œå¤æ‚JOINæ“ä½œ
- [x] **æŸ¥è¯¢ä¼˜åŒ–** - SQLæ€§èƒ½ä¼˜åŒ–å’Œæ‰§è¡Œè®¡åˆ’åˆ†æ

#### 1.3 ç»“æœå¤„ç†æ¨¡å—
- [x] **æ•°æ®æ ¼å¼åŒ–** - å°†æŸ¥è¯¢ç»“æœè½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„æ ¼å¼
- [x] **å›¾è¡¨ç”Ÿæˆ** - è‡ªåŠ¨ç”Ÿæˆç›¸å…³çš„å¯è§†åŒ–å›¾è¡¨
- [x] **ç»“æœè§£é‡Š** - æä¾›æŸ¥è¯¢ç»“æœçš„ä¸šåŠ¡è§£é‡Š
- [x] **å¯¼å‡ºåŠŸèƒ½** - æ”¯æŒå¤šç§æ ¼å¼çš„æ•°æ®å¯¼å‡º

### 2. æ•°æ®é›†æˆæ¨¡å—

#### 2.1 æ•°æ®æºæ•´åˆ
- [x] **è‚¡ç¥¨åŸºç¡€æ•°æ®** - æ•´åˆstock_basicã€stock_daily_historyç­‰è¡¨
- [x] **æŠ€æœ¯æŒ‡æ ‡æ•°æ®** - æ•´åˆstock_factorã€stock_ma_dataç­‰æŠ€æœ¯é¢æ•°æ®
- [x] **åŸºæœ¬é¢æ•°æ®** - æ•´åˆè´¢åŠ¡æŠ¥è¡¨æ•°æ®ï¼ˆåˆ©æ¶¦è¡¨ã€èµ„äº§è´Ÿå€ºè¡¨ã€ç°é‡‘æµé‡è¡¨ï¼‰
- [x] **èµ„é‡‘æµå‘æ•°æ®** - æ•´åˆstock_moneyflowã€stock_moneyflow_thsç­‰èµ„é‡‘é¢æ•°æ®
- [x] **å› å­æ•°æ®** - æ•´åˆfactor_valuesã€factor_definitionç­‰MLå› å­æ•°æ®

#### 2.2 æ•°æ®æ˜ å°„å’Œå…ƒæ•°æ®ç®¡ç†
- [x] **å­—æ®µæ˜ å°„è¡¨** - å»ºç«‹è‡ªç„¶è¯­è¨€åˆ°æ•°æ®åº“å­—æ®µçš„æ˜ å°„å…³ç³»
- [x] **ä¸šåŠ¡è¯å…¸** - ç»´æŠ¤è‚¡ç¥¨ã€æŒ‡æ ‡ã€è¡Œä¸šç­‰ä¸šåŠ¡æœ¯è¯­è¯å…¸
- [x] **æ•°æ®è¡€ç¼˜** - è¿½è¸ªæ•°æ®æ¥æºå’Œè®¡ç®—é€»è¾‘
- [x] **æ•°æ®è´¨é‡ç›‘æ§** - ç›‘æ§æ•°æ®å®Œæ•´æ€§å’Œå‡†ç¡®æ€§

## ğŸš€ å¼€å‘è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„æ­å»º (1-2å‘¨)

#### 1.1 Text2SQLæœåŠ¡æ¶æ„è®¾è®¡
```python
# app/services/text2sql_engine.py
class Text2SQLEngine:
    """Text2SQLå¼•æ“"""
    
    def __init__(self):
        self.nlp_processor = NLPProcessor()
        self.sql_generator = SQLGenerator()
        self.query_executor = QueryExecutor()
        self.result_formatter = ResultFormatter()
    
    def process_query(self, user_query: str) -> Dict[str, Any]:
        """å¤„ç†ç”¨æˆ·æŸ¥è¯¢"""
        # 1. è‡ªç„¶è¯­è¨€ç†è§£
        intent_result = self.nlp_processor.parse_intent(user_query)
        
        # 2. SQLç”Ÿæˆ
        sql_query = self.sql_generator.generate_sql(intent_result)
        
        # 3. æ‰§è¡ŒæŸ¥è¯¢
        query_result = self.query_executor.execute(sql_query)
        
        # 4. ç»“æœæ ¼å¼åŒ–
        formatted_result = self.result_formatter.format(query_result)
        
        return formatted_result
```

#### 1.2 æ•°æ®åº“å…ƒæ•°æ®ç®¡ç†
```python
# app/models/text2sql_metadata.py
class TableMetadata(db.Model):
    """è¡¨å…ƒæ•°æ®"""
    __tablename__ = 'table_metadata'
    
    table_name = db.Column(db.String(100), primary_key=True)
    table_alias = db.Column(db.String(100))
    description = db.Column(db.Text)
    business_domain = db.Column(db.String(50))  # æŠ€æœ¯é¢ã€åŸºæœ¬é¢ã€èµ„é‡‘é¢ç­‰

class FieldMetadata(db.Model):
    """å­—æ®µå…ƒæ•°æ®"""
    __tablename__ = 'field_metadata'
    
    table_name = db.Column(db.String(100), primary_key=True)
    field_name = db.Column(db.String(100), primary_key=True)
    field_alias = db.Column(db.String(100))
    field_type = db.Column(db.String(50))
    description = db.Column(db.Text)
    business_meaning = db.Column(db.Text)
    synonyms = db.Column(db.JSON)  # åŒä¹‰è¯åˆ—è¡¨

class QueryTemplate(db.Model):
    """æŸ¥è¯¢æ¨¡æ¿"""
    __tablename__ = 'query_template'
    
    template_id = db.Column(db.String(50), primary_key=True)
    template_name = db.Column(db.String(100))
    intent_pattern = db.Column(db.Text)  # æ„å›¾åŒ¹é…æ¨¡å¼
    sql_template = db.Column(db.Text)    # SQLæ¨¡æ¿
    parameters = db.Column(db.JSON)      # å‚æ•°å®šä¹‰
```

### ç¬¬äºŒé˜¶æ®µï¼šè‡ªç„¶è¯­è¨€å¤„ç† (2-3å‘¨)

#### 2.1 æ„å›¾è¯†åˆ«å’Œå®ä½“æŠ½å–
```python
# app/services/nlp_processor.py
class NLPProcessor:
    """è‡ªç„¶è¯­è¨€å¤„ç†å™¨"""
    
    def __init__(self):
        self.intent_classifier = IntentClassifier()
        self.entity_extractor = EntityExtractor()
        self.business_dict = BusinessDictionary()
    
    def parse_intent(self, user_query: str) -> Dict[str, Any]:
        """è§£æç”¨æˆ·æ„å›¾"""
        # 1. é¢„å¤„ç†
        cleaned_query = self._preprocess(user_query)
        
        # 2. æ„å›¾åˆ†ç±»
        intent = self.intent_classifier.classify(cleaned_query)
        
        # 3. å®ä½“æŠ½å–
        entities = self.entity_extractor.extract(cleaned_query)
        
        # 4. ä¸šåŠ¡æœ¯è¯­æ ‡å‡†åŒ–
        normalized_entities = self.business_dict.normalize(entities)
        
        return {
            'original_query': user_query,
            'cleaned_query': cleaned_query,
            'intent': intent,
            'entities': normalized_entities,
            'confidence': intent.get('confidence', 0.0)
        }

class IntentClassifier:
    """æ„å›¾åˆ†ç±»å™¨"""
    
    INTENT_PATTERNS = {
        'stock_screening': [
            r'ç­›é€‰.*è‚¡ç¥¨', r'æ‰¾.*è‚¡ç¥¨', r'å“ªäº›è‚¡ç¥¨', r'è‚¡ç¥¨.*æ¡ä»¶',
            r'æ¶¨å¹….*è‚¡ç¥¨', r'è·Œå¹….*è‚¡ç¥¨', r'æˆäº¤é‡.*è‚¡ç¥¨'
        ],
        'factor_analysis': [
            r'å› å­.*åˆ†æ', r'.*å› å­.*æ’å', r'å› å­.*åˆ†å¸ƒ',
            r'æŠ€æœ¯æŒ‡æ ‡.*åˆ†æ', r'åŸºæœ¬é¢.*åˆ†æ'
        ],
        'technical_indicator': [
            r'MACD.*', r'KDJ.*', r'RSI.*', r'å¸ƒæ—å¸¦.*',
            r'å‡çº¿.*', r'æˆäº¤é‡.*', r'æ¢æ‰‹ç‡.*'
        ],
        'fundamental_analysis': [
            r'PE.*', r'PB.*', r'ROE.*', r'è¥æ”¶.*', r'åˆ©æ¶¦.*',
            r'å¸‚ç›ˆç‡.*', r'å¸‚å‡€ç‡.*', r'è´¢åŠ¡.*'
        ],
        'money_flow': [
            r'èµ„é‡‘æµ.*', r'å¤§å•.*', r'ä¸»åŠ›.*', r'æœºæ„.*',
            r'å‡€æµå…¥.*', r'å‡€æµå‡º.*'
        ]
    }
```

#### 2.2 ä¸šåŠ¡è¯å…¸å’ŒåŒä¹‰è¯ç®¡ç†
```python
# app/services/business_dictionary.py
class BusinessDictionary:
    """ä¸šåŠ¡è¯å…¸"""
    
    def __init__(self):
        self.stock_synonyms = {
            'è‚¡ç¥¨ä»£ç ': ['ä»£ç ', 'è¯åˆ¸ä»£ç ', 'ts_code', 'è‚¡ç¥¨'],
            'æ”¶ç›˜ä»·': ['æ”¶ç›˜', 'æ”¶ä»·', 'close', 'ä»·æ ¼'],
            'æ¶¨è·Œå¹…': ['æ¶¨å¹…', 'è·Œå¹…', 'æ¶¨è·Œ', 'pct_change', 'æ¶¨è·Œç‡'],
            'æˆäº¤é‡': ['é‡', 'vol', 'volume', 'äº¤æ˜“é‡'],
            'æˆäº¤é¢': ['é¢', 'amount', 'äº¤æ˜“é¢', 'æˆäº¤é‡‘é¢'],
            'å¸‚ç›ˆç‡': ['PE', 'pe_ttm', 'P/E'],
            'å¸‚å‡€ç‡': ['PB', 'pb', 'P/B'],
            'æ¢æ‰‹ç‡': ['turnover_rate', 'æ¢æ‰‹'],
            'MACD': ['macd', 'MACDæŒ‡æ ‡', 'macd_dif', 'macd_dea'],
            'RSI': ['rsi', 'RSIæŒ‡æ ‡', 'rsi_6', 'rsi_12', 'rsi_24'],
            'å‡çº¿': ['MA', 'ma', 'ç§»åŠ¨å¹³å‡çº¿', 'ma5', 'ma10', 'ma20']
        }
        
        self.condition_synonyms = {
            'å¤§äº': ['>', 'è¶…è¿‡', 'é«˜äº', 'å¤§äºç­‰äº', '>='],
            'å°äº': ['<', 'ä½äº', 'å°‘äº', 'å°äºç­‰äº', '<='],
            'ç­‰äº': ['=', 'ç­‰äº', 'æ˜¯', 'ä¸º'],
            'æ’åº': ['æ’å', 'æ’åº', 'æ’åˆ—', 'order by'],
            'å‰': ['å‰', 'top', 'æœ€é«˜', 'æœ€å¤§'],
            'å': ['å', 'bottom', 'æœ€ä½', 'æœ€å°']
        }
```

### ç¬¬ä¸‰é˜¶æ®µï¼šSQLç”Ÿæˆå¼•æ“ (2-3å‘¨)

#### 3.1 SQLæ¨¡æ¿ç³»ç»Ÿ
```python
# app/services/sql_generator.py
class SQLGenerator:
    """SQLç”Ÿæˆå™¨"""
    
    def __init__(self):
        self.template_manager = TemplateManager()
        self.query_builder = QueryBuilder()
    
    def generate_sql(self, intent_result: Dict[str, Any]) -> str:
        """ç”ŸæˆSQLæŸ¥è¯¢"""
        intent = intent_result['intent']['name']
        entities = intent_result['entities']
        
        # 1. é€‰æ‹©åˆé€‚çš„æ¨¡æ¿
        template = self.template_manager.get_template(intent, entities)
        
        # 2. æ„å»ºSQL
        if template:
            sql = self._build_from_template(template, entities)
        else:
            sql = self.query_builder.build_dynamic_sql(intent, entities)
        
        # 3. SQLä¼˜åŒ–
        optimized_sql = self._optimize_sql(sql)
        
        return optimized_sql

class TemplateManager:
    """æ¨¡æ¿ç®¡ç†å™¨"""
    
    TEMPLATES = {
        'stock_screening_by_price': {
            'pattern': r'æ”¶ç›˜ä»·.*å¤§äº.*çš„è‚¡ç¥¨',
            'sql': '''
                SELECT ts_code, stock_name, close, pct_change, vol
                FROM stock_business 
                WHERE close > {price_threshold}
                ORDER BY close DESC
                LIMIT {limit}
            ''',
            'parameters': ['price_threshold', 'limit']
        },
        
        'stock_screening_by_pct_change': {
            'pattern': r'æ¶¨å¹….*å¤§äº.*çš„è‚¡ç¥¨',
            'sql': '''
                SELECT ts_code, stock_name, daily_close, factor_pct_change, vol
                FROM stock_business 
                WHERE factor_pct_change > {pct_threshold}
                ORDER BY factor_pct_change DESC
                LIMIT {limit}
            ''',
            'parameters': ['pct_threshold', 'limit']
        },
        
        'technical_indicator_analysis': {
            'pattern': r'MACD.*é‡‘å‰.*è‚¡ç¥¨',
            'sql': '''
                SELECT sb.ts_code, sb.stock_name, sf.macd_dif, sf.macd_dea, sf.macd
                FROM stock_business sb
                JOIN stock_factor sf ON sb.ts_code = sf.ts_code
                WHERE sf.macd_dif > sf.macd_dea 
                AND sf.trade_date = (
                    SELECT MAX(trade_date) FROM stock_factor WHERE ts_code = sb.ts_code
                )
                ORDER BY sf.macd DESC
                LIMIT {limit}
            ''',
            'parameters': ['limit']
        }
    }
```

#### 3.2 åŠ¨æ€SQLæ„å»ºå™¨
```python
# app/services/query_builder.py
class QueryBuilder:
    """åŠ¨æ€æŸ¥è¯¢æ„å»ºå™¨"""
    
    def build_dynamic_sql(self, intent: str, entities: Dict[str, Any]) -> str:
        """åŠ¨æ€æ„å»ºSQL"""
        
        # 1. ç¡®å®šä¸»è¡¨
        main_table = self._determine_main_table(intent, entities)
        
        # 2. æ„å»ºSELECTå­å¥
        select_clause = self._build_select_clause(entities)
        
        # 3. æ„å»ºFROMå­å¥ï¼ˆåŒ…å«JOINï¼‰
        from_clause = self._build_from_clause(main_table, entities)
        
        # 4. æ„å»ºWHEREå­å¥
        where_clause = self._build_where_clause(entities)
        
        # 5. æ„å»ºORDER BYå­å¥
        order_clause = self._build_order_clause(entities)
        
        # 6. æ„å»ºLIMITå­å¥
        limit_clause = self._build_limit_clause(entities)
        
        sql = f"""
            {select_clause}
            {from_clause}
            {where_clause}
            {order_clause}
            {limit_clause}
        """
        
        return sql.strip()
    
    def _determine_main_table(self, intent: str, entities: Dict[str, Any]) -> str:
        """ç¡®å®šä¸»è¡¨"""
        if intent in ['stock_screening', 'fundamental_analysis']:
            return 'stock_business'
        elif intent == 'technical_indicator':
            return 'stock_factor'
        elif intent == 'money_flow':
            return 'stock_moneyflow'
        elif intent == 'factor_analysis':
            return 'factor_values'
        else:
            return 'stock_business'  # é»˜è®¤ä¸»è¡¨
```

### ç¬¬å››é˜¶æ®µï¼šWebç•Œé¢é›†æˆ (1-2å‘¨)

#### 4.1 Text2SQLé¡µé¢
```html
<!-- app/templates/ml_factor/text2sql.html -->
<div class="container-fluid">
    <div class="row">
        <!-- æŸ¥è¯¢è¾“å…¥åŒºåŸŸ -->
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-comments"></i> æ™ºèƒ½æŸ¥è¯¢åŠ©æ‰‹</h5>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="queryInput" 
                               placeholder="è¯·è¾“å…¥æ‚¨çš„æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼šæ‰¾å‡ºæ¶¨å¹…å¤§äº5%çš„è‚¡ç¥¨">
                        <button class="btn btn-primary" type="button" id="queryBtn">
                            <i class="fas fa-search"></i> æŸ¥è¯¢
                        </button>
                    </div>
                    
                    <!-- æŸ¥è¯¢å»ºè®® -->
                    <div class="query-suggestions">
                        <small class="text-muted">æŸ¥è¯¢ç¤ºä¾‹ï¼š</small>
                        <div class="mt-2">
                            <span class="badge bg-light text-dark me-2 query-example">æ‰¾å‡ºæ”¶ç›˜ä»·å¤§äº100å…ƒçš„è‚¡ç¥¨</span>
                            <span class="badge bg-light text-dark me-2 query-example">MACDé‡‘å‰çš„è‚¡ç¥¨æœ‰å“ªäº›</span>
                            <span class="badge bg-light text-dark me-2 query-example">PEå°äº20çš„è‚¡ç¥¨æ’å</span>
                            <span class="badge bg-light text-dark me-2 query-example">èµ„é‡‘å‡€æµå…¥æœ€å¤šçš„10åªè‚¡ç¥¨</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æŸ¥è¯¢ç»“æœåŒºåŸŸ -->
    <div class="row mt-4" id="resultArea" style="display: none;">
        <!-- SQLè§£æç»“æœ -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-code"></i> æŸ¥è¯¢è§£æ</h6>
                </div>
                <div class="card-body">
                    <div id="intentResult"></div>
                    <div id="sqlResult"></div>
                </div>
            </div>
        </div>
        
        <!-- æ•°æ®ç»“æœ -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <h6><i class="fas fa-table"></i> æŸ¥è¯¢ç»“æœ</h6>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" id="exportBtn">
                            <i class="fas fa-download"></i> å¯¼å‡º
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="chartBtn">
                            <i class="fas fa-chart-bar"></i> å›¾è¡¨
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="dataTable"></div>
                    <div id="chartContainer" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
```

#### 4.2 APIæ¥å£
```python
# app/api/text2sql_api.py
@text2sql_bp.route('/query', methods=['POST'])
def process_query():
    """å¤„ç†è‡ªç„¶è¯­è¨€æŸ¥è¯¢"""
    try:
        data = request.get_json()
        user_query = data.get('query', '').strip()
        
        if not user_query:
            return jsonify({'error': 'æŸ¥è¯¢å†…å®¹ä¸èƒ½ä¸ºç©º'}), 400
        
        # å¤„ç†æŸ¥è¯¢
        result = get_text2sql_engine().process_query(user_query)
        
        return jsonify({
            'success': True,
            'query': user_query,
            'intent': result['intent'],
            'sql': result['sql'],
            'data': result['data'],
            'chart_config': result.get('chart_config'),
            'explanation': result.get('explanation')
        })
        
    except Exception as e:
        logger.error(f"å¤„ç†æŸ¥è¯¢å¤±è´¥: {e}")
        return jsonify({'error': str(e)}), 500

@text2sql_bp.route('/suggestions', methods=['GET'])
def get_query_suggestions():
    """è·å–æŸ¥è¯¢å»ºè®®"""
    try:
        suggestions = get_text2sql_engine().get_query_suggestions()
        return jsonify({
            'success': True,
            'suggestions': suggestions
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 500
```

### ç¬¬äº”é˜¶æ®µï¼šæµ‹è¯•å’Œä¼˜åŒ– (1-2å‘¨)

#### 5.1 æµ‹è¯•ç”¨ä¾‹è®¾è®¡
```python
# tests/test_text2sql.py
class TestText2SQL:
    """Text2SQLåŠŸèƒ½æµ‹è¯•"""
    
    def test_stock_screening_queries(self):
        """æµ‹è¯•è‚¡ç¥¨ç­›é€‰æŸ¥è¯¢"""
        test_cases = [
            {
                'query': 'æ‰¾å‡ºæ”¶ç›˜ä»·å¤§äº100å…ƒçš„è‚¡ç¥¨',
                'expected_intent': 'stock_screening',
                'expected_entities': {'price_threshold': 100, 'field': 'close'}
            },
            {
                'query': 'æ¶¨å¹…è¶…è¿‡5%çš„è‚¡ç¥¨æœ‰å“ªäº›',
                'expected_intent': 'stock_screening',
                'expected_entities': {'pct_threshold': 5, 'field': 'pct_change'}
            }
        ]
        
        for case in test_cases:
            result = self.text2sql_engine.process_query(case['query'])
            assert result['intent']['name'] == case['expected_intent']
    
    def test_technical_indicator_queries(self):
        """æµ‹è¯•æŠ€æœ¯æŒ‡æ ‡æŸ¥è¯¢"""
        test_cases = [
            'MACDé‡‘å‰çš„è‚¡ç¥¨',
            'RSIè¶…ä¹°çš„è‚¡ç¥¨',
            'å¸ƒæ—å¸¦çªç ´çš„è‚¡ç¥¨',
            'å‡çº¿å¤šå¤´æ’åˆ—çš„è‚¡ç¥¨'
        ]
        
        for query in test_cases:
            result = self.text2sql_engine.process_query(query)
            assert result['intent']['name'] == 'technical_indicator'
            assert len(result['data']) > 0
```

## ğŸ“Š æ•°æ®è¡¨è®¾è®¡

### Text2SQLå…ƒæ•°æ®è¡¨
```sql
-- è¡¨å…ƒæ•°æ®
CREATE TABLE `table_metadata` (
  `table_name` varchar(100) NOT NULL COMMENT 'è¡¨å',
  `table_alias` varchar(100) COMMENT 'è¡¨åˆ«å',
  `description` text COMMENT 'è¡¨æè¿°',
  `business_domain` varchar(50) COMMENT 'ä¸šåŠ¡åŸŸ',
  `is_active` tinyint(1) DEFAULT 1,
  PRIMARY KEY (`table_name`)
) COMMENT='è¡¨å…ƒæ•°æ®';

-- å­—æ®µå…ƒæ•°æ®
CREATE TABLE `field_metadata` (
  `table_name` varchar(100) NOT NULL,
  `field_name` varchar(100) NOT NULL,
  `field_alias` varchar(100) COMMENT 'å­—æ®µåˆ«å',
  `field_type` varchar(50) COMMENT 'å­—æ®µç±»å‹',
  `description` text COMMENT 'å­—æ®µæè¿°',
  `business_meaning` text COMMENT 'ä¸šåŠ¡å«ä¹‰',
  `synonyms` json COMMENT 'åŒä¹‰è¯',
  `is_active` tinyint(1) DEFAULT 1,
  PRIMARY KEY (`table_name`, `field_name`)
) COMMENT='å­—æ®µå…ƒæ•°æ®';

-- æŸ¥è¯¢æ¨¡æ¿
CREATE TABLE `query_template` (
  `template_id` varchar(50) NOT NULL,
  `template_name` varchar(100) NOT NULL,
  `intent_pattern` text COMMENT 'æ„å›¾åŒ¹é…æ¨¡å¼',
  `sql_template` text COMMENT 'SQLæ¨¡æ¿',
  `parameters` json COMMENT 'å‚æ•°å®šä¹‰',
  `usage_count` int DEFAULT 0 COMMENT 'ä½¿ç”¨æ¬¡æ•°',
  `is_active` tinyint(1) DEFAULT 1,
  PRIMARY KEY (`template_id`)
) COMMENT='æŸ¥è¯¢æ¨¡æ¿';

-- æŸ¥è¯¢å†å²
CREATE TABLE `query_history` (
  `id` bigint AUTO_INCREMENT,
  `user_query` text NOT NULL COMMENT 'ç”¨æˆ·æŸ¥è¯¢',
  `intent` varchar(50) COMMENT 'è¯†åˆ«æ„å›¾',
  `generated_sql` text COMMENT 'ç”Ÿæˆçš„SQL',
  `execution_time` decimal(10,3) COMMENT 'æ‰§è¡Œæ—¶é—´(ç§’)',
  `result_count` int COMMENT 'ç»“æœæ•°é‡',
  `is_successful` tinyint(1) COMMENT 'æ˜¯å¦æˆåŠŸ',
  `error_message` text COMMENT 'é”™è¯¯ä¿¡æ¯',
  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) COMMENT='æŸ¥è¯¢å†å²';
```

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### æ”¯æŒçš„æŸ¥è¯¢ç±»å‹

#### 1. è‚¡ç¥¨ç­›é€‰æŸ¥è¯¢
- "æ‰¾å‡ºæ¶¨å¹…å¤§äº5%çš„è‚¡ç¥¨"
- "æ”¶ç›˜ä»·åœ¨50-100å…ƒä¹‹é—´çš„è‚¡ç¥¨"
- "æˆäº¤é‡å‰20åçš„è‚¡ç¥¨"
- "å¸‚ç›ˆç‡å°äº20çš„è‚¡ç¥¨"

#### 2. æŠ€æœ¯æŒ‡æ ‡æŸ¥è¯¢
- "MACDé‡‘å‰çš„è‚¡ç¥¨æœ‰å“ªäº›"
- "RSIè¶…ä¹°çš„è‚¡ç¥¨"
- "å¸ƒæ—å¸¦ä¸Šè½¨çªç ´çš„è‚¡ç¥¨"
- "5æ—¥å‡çº¿ä¸Šç©¿20æ—¥å‡çº¿çš„è‚¡ç¥¨"

#### 3. åŸºæœ¬é¢åˆ†æ
- "ROEå¤§äº15%çš„è‚¡ç¥¨"
- "è¥æ”¶å¢é•¿ç‡æœ€é«˜çš„10åªè‚¡ç¥¨"
- "è´Ÿå€ºç‡æœ€ä½çš„è‚¡ç¥¨"
- "ç°é‡‘æµæœ€å¥½çš„è‚¡ç¥¨"

#### 4. èµ„é‡‘æµå‘åˆ†æ
- "ä¸»åŠ›èµ„é‡‘å‡€æµå…¥æœ€å¤šçš„è‚¡ç¥¨"
- "å¤§å•ä¹°å…¥æ¯”ä¾‹æœ€é«˜çš„è‚¡ç¥¨"
- "è¿ç»­3å¤©èµ„é‡‘å‡€æµå…¥çš„è‚¡ç¥¨"

#### 5. å› å­åˆ†æ
- "åŠ¨é‡å› å­æ’åå‰50çš„è‚¡ç¥¨"
- "ä»·å€¼å› å­å¾—åˆ†æœ€é«˜çš„è‚¡ç¥¨"
- "è´¨é‡å› å­è¡¨ç°æœ€å¥½çš„è¡Œä¸š"

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ä½“éªŒæå‡
- **æŸ¥è¯¢æ•ˆç‡æå‡80%** - ä»å¤æ‚SQLç¼–å†™åˆ°è‡ªç„¶è¯­è¨€è¾“å…¥
- **å­¦ä¹ æˆæœ¬é™ä½90%** - æ— éœ€æŒæ¡SQLè¯­æ³•å’Œæ•°æ®åº“ç»“æ„
- **æŸ¥è¯¢å‡†ç¡®æ€§æå‡** - æ™ºèƒ½çº é”™å’Œå»ºè®®åŠŸèƒ½

### ç³»ç»Ÿèƒ½åŠ›å¢å¼º
- **æŸ¥è¯¢è¦†ç›–ç‡95%** - æ”¯æŒç»å¤§å¤šæ•°å¸¸è§æŸ¥è¯¢åœºæ™¯
- **å“åº”æ—¶é—´<2ç§’** - å¿«é€Ÿçš„æ„å›¾è¯†åˆ«å’ŒSQLç”Ÿæˆ
- **æ‰©å±•æ€§å¼º** - æ˜“äºæ·»åŠ æ–°çš„æŸ¥è¯¢æ¨¡æ¿å’Œä¸šåŠ¡è§„åˆ™

è¿™ä¸ªå¼€å‘è®¡åˆ’å°†Text2SQLåŠŸèƒ½ä¸ç°æœ‰çš„å¤šå› å­æ¨¡å‹ç³»ç»Ÿæ·±åº¦é›†æˆï¼Œä¸ºç”¨æˆ·æä¾›å¼ºå¤§çš„æ™ºèƒ½æŸ¥è¯¢èƒ½åŠ›ï¼Œå¤§å¤§æå‡ç³»ç»Ÿçš„æ˜“ç”¨æ€§å’Œå®ç”¨æ€§ã€‚
